@page
@model IndexModel
@{
   ViewData["Title"] = "NERA";
}
@if (!Model.DbAvailable)
{
    <div class="alert alert-warning">
        Database is currently unreachable. Some features are disabled.
    </div>
}
<main class="container">
    <h1 class="page-title">Upcoming Events</h1>

    <!-- Filters Panel: search, status and city selectors -->
    <sl-card class="panel section">
        <div class="controls">
            <!-- Free-text search over the event title -->
            <sl-input id="search" placeholder="Search events…" clearable></sl-input>
            <!-- Status filter: All/Open/Closed -->
            <sl-select id="statusFilter" placeholder="Status" value="open" hoist>
                <sl-option value="all">All</sl-option>
                <sl-option value="open">Open for Registration</sl-option>
                <sl-option value="closed">Closed</sl-option>
            </sl-select>
            <!-- City filter (client-side only) -->
            <sl-select id="cityFilter" placeholder="City" hoist>
                <sl-option value="all">All Cities</sl-option>
                <sl-option value="Amsterdam">Amsterdam Office</sl-option>
                <sl-option value="Eindhoven">Eindhoven Office</sl-option>
                <sl-option value="Arnhem">Arnhem Office</sl-option>
                <sl-option value="Groningen">Groningen Office</sl-option>
                <sl-option value="Rotterdam">Rotterdam Office</sl-option>
                <sl-option value="Maastricht">Maastricht Office</sl-option>
                <sl-option value="Other Location">Other Location</sl-option>
            </sl-select>
            <sl-button id="myCalendarBtn" variant="primary" class="btn-calendar">
                <sl-icon slot="prefix" name="calendar"></sl-icon>
                My Calendar
            </sl-button>
        </div>
    </sl-card>

    <!-- Events Grid: responsive 1/2/3-column layout -->
    <section id="events" class="events-grid"></section>
</main>
<script>
    // use pagemodel data instead of fetching /api/events
    // serialized with camelCase to match existing clinet mapping
    const __serverEvents = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Events.Select(e => new
        {
            id = e.Id,
            title = e.Title,
            startDate = e.StartDate,
            endDate = e.EndDate,
            cgi = e.CGI,
            adress = e.Adress,
            status = e.Status.ToString(),
            cost = e.Cost,
            capacity = e.Capacity,
            description = e.Description
        }),

    new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
    // keep then same mapping shape then rest of your client code expects
    async function getEvents() {
        try {
            // map server-provided events to the client shape (same logic as before)
            return __serverEvents.map(e => {
                const title = e.title ?? e.Title ?? '';
                const start = e.startDate ?? e.StartDate;
                const end = e.endDate ?? e.EndDate;
                const cgi = e.cgi ?? e.cgi ?? '';
                const adress = e.adress ?? e.adress ?? '';
                const cost = e.cost ?? e.Cost;
                const capacity = e.capacity ?? e.Capacity;
                const description = e.description ?? e.Description ?? '';
                const rawStatus = e.status ?? e.Status; // may be string or enum numeric

                let statusText;
                if (typeof rawStatus === 'string') {
                    statusText = rawStatus;
                } else {
                    // Assuming EventStatus enum: 0 = Open, 1 = Closed
                    statusText = rawStatus === 0 ? 'Open for Registration' : 'Closed';
                }
                // Map location to city for filtering (see if we need this)
                let city = '';
                if (cgi === 'Amsterdam' || cgi === 'Eindhoven' || cgi === 'Arnhem' || cgi === 'Groningen' || cgi === 'Rotterdam' || cgi === 'Maastricht' || cgi === 'Online') {
                    city = cgi;
                } else if (cgi && cgi.trim() !== '') {
                    city = 'Other Location';
                }

                return {
                    id: e.id,
                    title,
                    date: start ? new Date(start).toLocaleDateString() : '',
                    startTime: start ? new Date(start).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                    endTime: end ? new Date(end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                    cgi,
                    city: city,
                    adress,
                    status: statusText,
                    cost,
                    capacity,
                    description
                };
            });
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('statusFilter').value = 'open';
    });
</script>


<!-- Calendar Modal -->
<sl-dialog id="calendarModal" label="My Calendar" class="calendar-modal">
    <div id="calendarContent">
        <!-- Calendar will be populated dynamically -->
    </div>
    <div slot="footer" class="modal-footer">
        <sl-button id="closeCalendar" variant="default">Close</sl-button>
    </div>
</sl-dialog>

<!-- Event Details Modal -->
<sl-dialog id="eventModal" label="Event Details" class="event-details-modal">
    <div id="modalContent">
        <!-- Content will be populated dynamically -->
    </div>
    <div slot="footer" class="modal-footer">
        <!-- Trash Icon (form posts to the page handler). Hidden input 'id' set from JS when modal opens -->
        <form id="deleteForm" method="post" asp-page-handler="Delete">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" id="deleteId" value="" />
            <button type="submit" class=" trash-button" title="Delete event">
                <sl-icon name="trash" class="trash-icon"></sl-icon>
            </button>
        </form>

        <sl-button id="registerBtn" variant="primary" class="btn-gradient">Register</sl-button>
        <sl-button id="closeModal" variant="default">Close</sl-button>
    </div>
</sl-dialog>

<script>
    const eventsRoot = document.getElementById('events');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const cityFilter = document.getElementById('cityFilter');
    statusFilter.addEventListener('sl-after-hide', () => { });
    if (!statusFilter.value) statusFilter.value = 'all';
    if (!cityFilter.value) cityFilter.value = 'all';

    // Render helper: creates one Shoelace <sl-card> per event
    function render(list) {
        eventsRoot.innerHTML = '';
        list.forEach(ev => {
            const card = document.createElement('sl-card');
            card.className = 'event-card';
            const isOpen = ev.status && ev.status.toLowerCase().includes('open');
            card.innerHTML = `
                    <div class="accent-bar"></div>
                    <h2>${ev.title}</h2>
                    <div class="event-meta">
                    <div><strong>Date:</strong> ${ev.date}</div>
                    <div><strong>CGI office:</strong> ${ev.cgi}</div>
                    <div><strong>Address:</strong> ${ev.adress}</div>
                    <div><strong>Status:</strong> ${isOpen ? '<sl-badge class="gradient">Open for Registration</sl-badge>' : '<sl-badge variant="neutral">Closed</sl-badge>'}</div>
                    </div>
                    <div class="event-actions">
                    <sl-button pill ${isOpen ? 'class="btn-register pulse"' : 'class="btn-details"'} data-event-id="${ev.id}">${isOpen ? 'Register' : 'Details'}</sl-button>
                    <sl-icon name="pencil" class="pencil-icon" data-event-id="${ev.id}"></sl-icon>
                    </div>
                `;


            // Add click handlers to the buttons
            const registerButton = card.querySelector('.btn-register, .btn-details');

            registerButton.addEventListener('click', () => showEventDetails(ev));

            // edit pencil click -> navigate to createevent page in edit mode with event id
            const editIcon = card.querySelector('.pencil-icon');
            editIcon.addEventListener('click', (e) => {
                e.preventDefault();
                // Reuse the Create Event page in edit mode by passing the id
                window.location.href = `/createevent?id=${encodeURIComponent(ev.id)}`;
            });

            eventsRoot.appendChild(card);
        });
    }

    // Applies client-side filters based on search text, status and city
    async function applyFilters() {
        const events = await getEvents();
        const term = String(search.value ?? '').trim().toLowerCase();
        const status = statusFilter.value || 'all';
        const city = cityFilter.value || 'all';
        if (term === '' && status === 'all' && city === 'all') {
            render(events);
            return;
        }
        const filtered = events.filter(e => {
            const matchesTerm = term === '' || e.title.toLowerCase().includes(term);
            const matchesStatus = status === 'all' || (status === 'open' ? e.status.toLowerCase().includes('open') : e.status.toLowerCase() === 'closed');
            const matchesCity = city === 'all' || e.city === city;
            return matchesTerm && matchesStatus && matchesCity;
        });
        render(filtered);
    }

    // Listen to Shoelace events for live filtering
    [statusFilter, cityFilter].forEach(el => el.addEventListener('sl-change', applyFilters));
    search.addEventListener('sl-input', applyFilters);
    search.addEventListener('sl-clear', applyFilters);
    search.addEventListener('sl-change', applyFilters);

    // Ensure initial render after components are upgraded
    window.customElements.whenDefined('sl-select').then(applyFilters);

    // Modal functionality
    const eventModal = document.getElementById('eventModal');
    const modalContent = document.getElementById('modalContent');
    const registerBtn = document.getElementById('registerBtn');
    const closeModal = document.getElementById('closeModal');
    const deleteIdInput = document.getElementById('deleteId');
    let currentEvent = null;

    // Show event details in modal (pop up page)
    function showEventDetails(event) {
        currentEvent = event;
        const isOpen = event.status && event.status.toLowerCase().includes('open');

        modalContent.innerHTML = `
                    <div class="event-details">
                        <h2>${event.title}</h2>
                        <div class="event-info">
                            <div class="info-row">
                                <strong>Date:</strong> ${event.date}
                            </div>
                            <div class="info-row">
                                <strong>Start Time:</strong> ${event.startTime || 'N/A'}
                            </div>
                            <div class="info-row">
                                <strong>End Time:</strong> ${event.endTime || 'N/A'}
                            </div>
                            <div class="info-row">
                                <strong>cgi office:</strong> ${event.cgi || ''}
                            </div>
                            <div class="info-row">
                                <strong>Adress:</strong> ${event.adress || ''}
                            </div>
                            <div class="info-row">
                                <strong>Status:</strong> ${isOpen ? '<sl-badge class="gradient">Open for Registration</sl-badge>' : '<sl-badge variant="neutral">Closed</sl-badge>'}
                            </div>
                            <div class="info-row">
                                <strong>Description:</strong>
                                <p>${event.description || ''}</p>
                            </div>
                            <div class="info-row">
                                <strong>Cost:</strong> €${event.cost || ' N/A'}
                            </div>
                            <div class="info-row">
                                <strong>Capacity:</strong> ${event.capacity || 'Unlimited'} participants
                            </div>
                        </div>
                    </div>
                `;

        // Set the hidden delete id so the Razor Page handler receives it
        if (deleteIdInput) {
            deleteIdInput.value = event.id ?? event.Id ?? '';
        }

        // Show/hide register button based on status
        registerBtn.style.display = isOpen ? 'block' : 'none';
        registerBtn.textContent = isOpen ? 'Register Now' : 'Registration Closed';
        registerBtn.disabled = !isOpen;

        eventModal.show();
    }

    // Register button handler
    registerBtn.addEventListener('click', async () => {
        if (!currentEvent) return;

        try {
            const response = await fetch(`?handler=Register`, {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ EventId: currentEvent.id })
            });

            const result = await response.json();

            if (result.success) {
                alert(`You're registered for "${currentEvent.title}" 🎉`);
            } else {
                alert("Something went wrong registering.");
            }

            eventModal.hide();

        } catch (err) {
            console.error(err);
            alert("Error while registering.");
        }
    });

    // Close modal handler
    closeModal.addEventListener('click', () => {
        eventModal.hide();
    });

    // Calendar functionality
    const calendarModal = document.getElementById('calendarModal');
    const calendarContent = document.getElementById('calendarContent');
    const myCalendarBtn = document.getElementById('myCalendarBtn');
    const closeCalendar = document.getElementById('closeCalendar');

    // Show calendar modal
    myCalendarBtn.addEventListener('click', () => {
        showCalendar();
    });

    // Close calendar modal
    closeCalendar.addEventListener('click', () => {
        calendarModal.hide();
    });

    // Generate calendar
    async function showCalendar() {
        const events = await getEvents();
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();

        let calendarHTML = `
                    <div class="calendar-header">
                        <h3>${monthNames[currentMonth]} ${currentYear}</h3>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                `;

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarHTML += '<div class="calendar-day empty"></div>';
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            calendarHTML += `
                        <div class="calendar-day">
                            <span class="day-number">${day}</span>
                        </div>
                    `;
        }

        calendarHTML += '</div>';

        calendarContent.innerHTML = calendarHTML;
        calendarModal.show();
    }


    // Initial render
    getEvents().then(events => {
        render(events);

    });


</script>

<link rel="stylesheet" href="~/css/index.css" asp-append-version="true" />




